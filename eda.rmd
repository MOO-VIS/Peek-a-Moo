```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
suppressPackageStartupMessages(library(qqplotr))
library(tidyverse, quietly = TRUE)
library(broom)
library(lubridate)
library(plotly)
library(ggplot2)
```

```{r}
my_df <- bind_rows(dashboard_Insentec$`Replacement behaviour by date`, .id = "date")

#my_df 
```

```{r}
make_analysis_df <- function(df) {
  df <- bind_rows(df, .id = "date")
}
```

```{r}
actor_reactor_analysis <- function(df) {
  
  df <- make_analysis_df(df)
  
  df %>%
    group_by(Actor_cow, date) %>%
    mutate(actor_cow_freq = n(),
           unique_reactor_cows_kicked = length(unique(Reactor_cow))) %>%
    ungroup() %>%
    group_by(Reactor_cow, date) %>%
    mutate(reactor_cow_freq = n(), 
           unique_actor_cows_kicking = length(unique(Actor_cow)))
}
```

```{r}
prepare_plotting_data <- function(df, cow_id) {

actor_reactor_analysis_df <- actor_reactor_analysis(df)
 
cow_act_df <- actor_reactor_analysis_df %>%
              filter(Actor_cow == cow_id) 

cow_reac_df <- actor_reactor_analysis_df %>%
                filter(Reactor_cow == cow_id)
          
cow_act_df$date <- ymd(cow_act_df$date)

cow_reac_df$date <- ymd(cow_reac_df$date)

return(list(cow_act_df, cow_reac_df))
}
```

```{r}

plot_bully_analysis <- function(df) {
  
 cow_act_df <- prepare_plotting_data(df)[1]
 cow_reac_df <- prepare_plotting_data(df)[2]
  
colours <- c("Being Actor" = "steelblue", "Unique Cows kicked" = "red",
             "Being Reactor" = "yellow", "Unique cows kicking" = "green")

first_plot <- ggplot(cow_act_df, aes(x = date)) +
  geom_line(aes(y = actor_cow_freq, color = "Being Actor")) +
  geom_line(aes(y = unique_reactor_cows_kicked, color = "Unique Cows kicked")) +
  geom_point(shape = 2, aes(y = actor_cow_freq, color = "Being Actor")) +
  geom_point(shape = 12, aes(y = unique_reactor_cows_kicked, color = "Unique Cows kicked")) +
  
  geom_line(data = cow_reac_df, aes(y = reactor_cow_freq, color = "Being Reactor")) +
  geom_line(data = cow_reac_df, aes(y = unique_actor_cows_kicking, color = "Unique cows kicking")) +
  geom_point(shape = 18, data = cow_reac_df, aes(y = reactor_cow_freq, color = "Being Reactor")) +
  geom_point(shape = 8, data = cow_reac_df, aes(y = unique_actor_cows_kicking, color = "Unique cows kicking")) +
  scale_x_date(date_labels = "%B-%y") +
  labs(x = 'Date', y = 'Frequency', color = "Legend") +
  scale_color_manual(values = colours) +
  theme(axis.text.x=element_text(angle = 60, hjust = 1))

ggplotly(first_plot)
  
}

```


```{r}
actor_reactor_analysis <- my_df %>%
    group_by(Actor_cow, date) %>%
    mutate(actor_cow_freq = n(),
           unique_reactor_cows_kicked = length(unique(Reactor_cow))) %>%
    ungroup() %>%
    group_by(Reactor_cow, date) %>%
    mutate(reactor_cow_freq = n(), 
           unique_actor_cows_kicking = length(unique(Actor_cow)))

actor_reactor_analysis
```


```{r}
cow_id = 6130

cow_6130 <- actor_reactor_analysis %>%
          filter(Actor_cow == cow_id) 

cow_reac_6130 <- actor_reactor_analysis %>%
                 filter(Reactor_cow == cow_id)
          
cow_6130$date <- ymd(cow_6130$date)

cow_reac_6130$date <- ymd(cow_reac_6130$date)

cow_reac_6130
```

```{r}

colours <- c("Being Actor" = "steelblue", "Unique Cows kicked" = "red",
             "Being Reactor" = "yellow", "Unique cows kicking" = "green")

first_plot <- ggplot(cow_6130, aes(x = date)) +
  geom_line(aes(y = actor_cow_freq, color = "Being Actor")) +
  geom_line(aes(y = unique_reactor_cows_kicked, color = "Unique Cows kicked")) +
  geom_point(shape = 2, aes(y = actor_cow_freq, color = "Being Actor")) +
  geom_point(shape = 12, aes(y = unique_reactor_cows_kicked, color = "Unique Cows kicked")) +
  
  geom_line(data = cow_reac_6130, aes(y = reactor_cow_freq, color = "Being Reactor")) +
  geom_line(data = cow_reac_6130, aes(y = unique_actor_cows_kicking, color = "Unique cows kicking")) +
  geom_point(shape = 18, data = cow_reac_6130, aes(y = reactor_cow_freq, color = "Being Reactor")) +
  geom_point(shape = 8, data = cow_reac_6130, aes(y = unique_actor_cows_kicking, color = "Unique cows kicking")) +
  scale_x_date(date_labels = "%B-%y") +
  labs(x = 'Date', y = 'Frequency', color = "Legend") +
  scale_color_manual(values = colours) +
  theme(axis.text.x=element_text(angle = 60, hjust = 1))

ggplotly(first_plot)
```

```{r}
library(tidyverse, quietly = TRUE)
library(broom)
library(lubridate)
library(plotly)
library(ggplot2)




```
